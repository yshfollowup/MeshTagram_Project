<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<html>
<head>
<script type="text/javascript" src="/js/custom.js"></script>
<style type="text/css" data-isostyle-id="is7ec0573d">
@media ( min-width :1000px) {
	._owark ._gsusx {
		-webkit-box-orient: horizontal;
		-webkit-box-direction: normal;
		-webkit-flex-direction: row;
		-ms-flex-direction: row;
		flex-direction: row;
		-webkit-box-flex: 1;
		-webkit-flex-grow: 1;
		-ms-flex-positive: 1;
		flex-grow: 1;
		-webkit-box-pack: center;
		-webkit-justify-content: center;
		-ms-flex-pack: center;
		justify-content: center;
	}
}

._owark {
	-webkit-box-flex: 1;
	-webkit-flex-grow: 1;
	-ms-flex-positive: 1;
	flex-grow: 1;
	margin: 0 auto;
	position: relative;
	width: 100%;
}

._gsusx {
	display: -webkit-box;
	display: -webkit-flex;
	display: -ms-flexbox;
	display: flex;
	-webkit-box-orient: horizontal;
	-webkit-box-direction: normal;
	-webkit-flex-flow: row nowrap;
	-ms-flex-flow: row nowrap;
	flex-flow: row nowrap;
	max-width: 935px
}

._62ky5 {
	display: block
}

._k46tg {
	display: inline-block;
	margin-top: 2px;
	vertical-align: middle
}

._14b0y {
	margin-bottom: 30px
}

._d4oao {
	float: left;
	margin-right: 28px;
	max-width: 614px;
	width: 100%
}

._s5vjd:last-child {
	margin-bottom: 0
}

._7axot {
	-webkit-align-self: center;
	-ms-flex-item-align: center;
	align-self: center
}

._qgv8j {
	-webkit-box-orient: horizontal;
	-webkit-box-direction: normal;
	-webkit-flex-direction: row;
	-ms-flex-direction: row;
	flex-direction: row;
	-webkit-box-pack: justify;
	-webkit-justify-content: space-between;
	-ms-flex-pack: justify;
	justify-content: space-between;
	padding-top: 8px
}

._m0zxo {
	position: fixed;
	bottom: 0;
	left: 0
}

._hw7lt {
	background: 0 0;
	border: 0;
	margin: 0;
	padding: 0
}

@media ( min-width :640px) {
	._owark {
		padding-top: 60px;
		-webkit-box-orient: horizontal;
		-webkit-box-direction: normal;
		-webkit-flex-direction: row;
		-ms-flex-direction: row;
		flex-direction: row;
		-webkit-box-flex: 1;
		-webkit-flex-grow: 1;
		-ms-flex-positive: 1;
		flex-grow: 1;
		-webkit-box-pack: center;
		-webkit-justify-content: center;
		-ms-flex-pack: center;
		justify-content: center;
	}
	._2wxtj {
		background: #fff;
		border-radius: 3px;
		border: 1px solid #efefef
	}
	._4sf0r, ._7g4gl, ._nx5in, ._ouv75, ._psd08, ._s5vjd {
		background-color: #fff;
		margin-left: -1px;
		margin-right: -1px
	}
	._4sf0r, ._nx5in, ._ouv75, ._psd08, ._s5vjd {
		border-radius: 3px;
		border: 1px solid #e6e6e6
	}
	._2wxtj, ._7g4gl, ._s5vjd {
		margin-bottom: 60px
	}
	._nx5in, ._ouv75, ._psd08 {
		margin-bottom: 20px
	}
}

@media ( max-width :640px) {
	._owark {
		margin-bottom: 10px;
	}
	._nx5in, ._ouv75, ._psd08 {
		border-bottom: 1px solid #e6e6e6
	}
	._nx5in, ._ouv75 {
		background-color: #fff
	}
}

@media ( max-width :735px) {
	._2wxtj, ._s5vjd {
		margin-bottom: 15px
	}
	._7g4gl {
		margin-bottom: 30px
	}
}
</style>
<style>
a, b {
	text-decoration: none;
	font-family: 맑은 고딕;
}

._8fi2q {
	-webkit-box-flex: 1;
	-webkit-flex-grow: 1;
	-ms-flex-positive: 1;
	flex-grow: 1;
	-webkit-box-ordinal-group: 5;
	-webkit-order: 4;
	-ms-flex-order: 4;
	order: 4
}

._havey {
	-webkit-box-orient: vertical;
	-webkit-box-direction: normal;
	-webkit-flex-direction: column;
	-ms-flex-direction: column;
	flex-direction: column;
}

._11dqz {
	position: left;
	right: 0;
	width: 100%;
	height: 100vh;
	margin-bottom: 30px;
	padding: 0;
	top: 60px;
}

._i4wsm {
	-webkit-box-align: center;
	-webkit-align-items: center;
	-ms-flex-align: center;
	align-items: center;
	display: -webkit-box;
	display: -webkit-flex;
	display: -ms-flexbox;
	display: flex;
	-webkit-box-orient: horizontal;
	-webkit-box-direction: normal;
	-webkit-flex-direction: row;
	-ms-flex-direction: row;
	flex-direction: row;
	height: 650px;
	width: 745px;
	-webkit-box-pack: justify;
	-webkit-justify-content: space-between;
	-ms-flex-pack: justify;
	justify-content: space-between;
	margin-top: 20px;
	border: 1px solid #DCDCDC;
	-webkit-box-pack: justify;
}

@media ( max-width :744px) {
	._i4wsm {
		-webkit-box-align: center;
		-webkit-align-items: center;
		-ms-flex-align: center;
		align-items: center;
		display: -webkit-box;
		display: -webkit-flex;
		display: -ms-flexbox;
		display: flex;
		-webkit-box-orient: horizontal;
		-webkit-box-direction: normal;
		-webkit-flex-direction: row;
		-ms-flex-direction: row;
		flex-direction: row;
		height: 650px;
		width: 100%;
		-webkit-box-pack: justify;
		-webkit-justify-content: space-between;
		-ms-flex-pack: justify;
		justify-content: space-between;
		margin-top: 20px;
		border: 1px solid #DCDCDC;
	}
}

@media ( max-height : 600px) {
	._i4wsm {
		-webkit-box-align: center;
		-webkit-align-items: center;
		-ms-flex-align: center;
		align-items: center;
		display: -webkit-box;
		display: -webkit-flex;
		display: -ms-flexbox;
		display: flex;
		-webkit-box-orient: horizontal;
		-webkit-box-direction: normal;
		-webkit-flex-direction: row;
		-ms-flex-direction: row;
		flex-direction: row;
		height: 400px;
		width: 100%;
		-webkit-box-pack: justify;
		-webkit-justify-content: space-between;
		-ms-flex-pack: justify;
		justify-content: space-between;
		margin-top: 80px;
		border: 1px solid #DCDCDC;
	}
}

._ikq0n {
	-webkit-box-align: center;
	-webkit-align-items: center;
	-ms-flex-align: center;
	align-items: center;
	display: -webkit-box;
	display: -webkit-flex;
	display: -ms-flexbox;
	display: flex;
	-webkit-box-orient: horizontal;
	-webkit-box-direction: normal;
	-webkit-flex-direction: row;
	-ms-flex-direction: row;
	flex-direction: row;
	height: 100%;
	margin-bottom: 12px;
	max-height: 50px;
	width: 100%;
	padding-left: 5px;
}

._82odm {
	-webkit-align-self: center;
	-ms-flex-item-align: center;
	align-self: center;
	display: block;
	-webkit-box-flex: 0;
	-webkit-flex: none;
	-ms-flex: none;
	flex: none;
}

body {
	height: 70px;
}
</style>

<title>MeshTagram</title>
</head>
<body class="_8fi2q" style="background-color: #fafafa">

	<section class="_owark _gsusx">
		<div class="_havey"
			style="margin: 0 20px; border-right: 1px solid #BDBDBD; min-width: 150px;">
			<c:forEach items="${followList }" var="obj">
				<ul class="nav nav-pills nav-stacked">
					<li><a href="#${obj.ID }"><span id="${obj.ID}"
							class="mesen" name="${obj._id }"><b>${obj.ID }</b></span>
							<span id="sp_${obj.ID }"></span></a></li>
				</ul>
			</c:forEach>
		</div>



		<!-- 우측 채팅창~~~~ -->
		<div class="_11dqz">
			<div style="position: fixed;">
				<div class="_i4wsm">
					<div class="_82odm" style="height: 100%; width: 100%;">
						<div id="chatBoard"
							style="width: 100%; height: 85%; overflow-y: scroll; background-color: white; border-bottom: 1px solid #DCDCDC; overflow:auto">
							<span id="showdm" ></span>
							<div id="showre"></div>
						</div>

						<div style="width: 100%; margin-top:20px;" align="center" >대화내용 입력<br/><br/>
							<input type="text" name="target" id="sender" class="sender"  style="width: 99%;"/>
						</div>
					</div>
				</div>
			</div>
		</div>

	</section>
</body>
<script>
	var setid = "${cookie.setId.value}";
	var reid2="";
	var thread;
	
	$(".mesen").on("click", function() {
		if(thread != undefined)
			clearInterval(thread);
		
		var reid = $(this).attr("id");
		console.log("들어왔다." + reid);
		var second=1000;
		thread=setInterval(function(){
			findAllMessage(reid);}, 3000);
		reid2=reid;
	});
	
	$(".sender").on("change", function() {
		var content = $(".sender").val();
		var scope = 0;
		var like = 0;
		if (content.length == 0) {
			window.alert("댓글을 작성해주세요.");
			return;
		}
		console.log("채팅을 치자"+reid2);
		$.ajax("/direct/insertMessage.do", {
			"method" : "get",
			"async" : false,
			"data" : {
				"sender" : setid,
				"target" : reid2,
				"content" : content,
				"like" : like,
				"scope" : scope
			}
		}).done(function(val) {
			$("#sender").val("");
			console.log(val);
			findAllMessage(reid2);
		})
	}); 
	
	showMessage();

	function setDigit(num, digit) {
		var zero = "";
		num = num.toString();
		if (num.length < digit) {
			for (var i = 0; i < digit; i++) {
				zero += "0";
			}
		}
		return zero + num;
	}
	
	function display() {
		var now = new Date();
		var currentHour = setDigit(now.getHours(), 2);
		var currentMinute = setDigit(now.getMinutes(), 2);
		var currentSecond = setDigit(now.getSeconds(), 2);
		var apm = "am";
		if (currentHour >= 12) {
			apm = "pm";
			currentHour = setDigit(now.getHours() - 12, 2);
		}
		$("#time").html();
	}

	setTimeout(display, 1000);
	
	function showMessage() {
		senderId = [];
		console.log("체크하거라");
		$(".mesen").each(function() {
			console.log($(this).attr("id"));
			senderId.push($(this).attr("id"));
		});
		
		console.log(senderId);
		if(senderId !=""){			
			$.ajax("/direct/senderId.do", {
				"method" : "get",
				"async" : true,
				"data" : {
					"sender" : senderId,
					"target" : setid
				}
	
			}).done(function(val) {
				console.log(val);
				for (var i = 0; i < val.length; i++) {
					var a = 0;
					if (val[i].scope == "0") {
						a++;
						console.log(val[i].sender+"이사랑이 보냄");
						$("#sp_" + val[i].sender).html("1");
					}
	
				}
			});
		}
	}

	function findAllMessage(reid) {
		var code;
		var target=reid;
		var oid;
		console.log(reid+"이것이 들어왔다."+setid+target);
		$.ajax("/direct/showMessage.do", {
			"method" : "post",
			"async" : true,
			"data" : {
				"sender" : setid,
				"target" : target
			}
		}).done(function(val) {
			console.log(val);
			$("#showdm").html("");
			$("#showre").html("");
			for (var i = 0; i < val.length; i++) {
				var bt = "<input class=\"_eszkz _l9yih like\" name=\""+val[i].code+"\" type=\"image\" id=\"like_${obj._id }\" src=\"/images/sheart.png\"/>";
				var bt2 = "<input class=\"_eszkz _l9yih dislike\" name=\""+val[i].code+"\" type=\"image\" id=\"dislike_${obj._id }\" src=\"/images/sheart_full.png\"/>";
				//console.log(val[i].content + val.length);
				if (val[i].sender == setid) {
					if(val[i].like =="좋아요"){
						$("#showdm").append(
								"<div id="+val[i].sender+"\" style=\"font-size:16px; text-align: right;  \">"
										+ bt2 +"&nbsp;&nbsp;&nbsp;&nbsp;"+ val[i].sender + " : "
										+ val[i].content
										+ "</button>" + "</div>"
										+ "<br/>");		
					}else{						
						$("#showdm").append(
								"<div id="+val[i].sender+"\" style=\"font-size:16px; text-align: right; \">"
										+ bt +"&nbsp;&nbsp;&nbsp;&nbsp;"+ val[i].sender + " : "
										+ val[i].content
										+ "</button>" + "</div>"
										+ "<br/>");
					}
				} else {
					if(val[i].like=="좋아요"){
						$("#showdm").append(
							"<div id="+val[i].sender+"\" style=\" text-align: left; \"  >"
								+ bt2 +"&nbsp;&nbsp;&nbsp;&nbsp;"+ val[i].sender + " : "
								+ val[i].content
								+ "</button>" + "</div>"
								+ "<br/>");
					} else {
						
					$("#showdm").append(
						"<div id="+val[i].sender+"\"align=right\" style=\"text-align: left; \" >"
							+ bt +"&nbsp;&nbsp;&nbsp;&nbsp;"+ val[i].sender + " : "
							+ val[i].content
							+ "</button>" + "</div>"
							+ "<br/>");
				
					}
					
					target = val[i].sender;
					//console.log(target + "저장");
				}
								
								
			}
			
			$("#chatBoard").scrollTop($("#chatBoard").prop("scrollHeight"));
			//	console.log("타켓팅" + reid + "scope업데이트");
			$.ajax("/direct/updateScope.do", {
				"method" : "get",
				"async" : true,
				"data" : {
					"sender" : setid,
					"target" : target
				}

			}).done(function(val2) {
				var a = 0;
			//	console.log("업데이트 ");
				$("#sp_" + target).html(" ");
			});
			
			$("#charBoard").scrollTop();
			//======
			//좋아요 취소
			$(".dislike").on("click", function(){
				var oid = $(this).attr("name");
				console.log(oid);
				$.ajax("/direct/deleteLike.do",{
					"method" : "get",
					"async" :true,
					"data" :{
						"sender": setid,
						"target" : reid,
						"oid" : oid			
					}
				}).done(function(val){
					checkLike(reid);
				});
			});
			
			//=======
			//좋아요 버튼
			$(".like").on("click", function() {
				var oid = $(this).attr("name");
				console.log(oid);
				$.ajax("/direct/updateLike.do", {
					"method" : "get",
					"async" : true,
					"data" : {
						"sender" : setid,
						"target" : reid,
						"oid" : oid
					}
				}).done(function(val) {
				//=====================================================
				//	console.log(val+"좋아요 버튼이 들어왔다잉");
					checkLike(reid);
				//=====================================================
				});
								//====================================================================
			});
		});
	};
//=========================================================================================
	function checkLike(reid) {
		var code;
		var target;
		var oid;
		console.log(reid+"이게 문제네");
		$.ajax("/direct/showMessage.do", {
			"method" : "post",
			"async" : true,
			"data" : {
				"sender" : setid,
				"target" : reid
			}
		}).done(
			function(val) {
				console.log(val);
				$("#showdm").html("");
				$("#showre").html("");
				
				for (var i = 0; i < val.length; i++) {
					var bt = "<input class=\"_eszkz _l9yih like\" name=\""+val[i].code+"\" type=\"image\" id=\"like_${obj._id }\" src=\"/images/sheart.png\"/>";
					var bt2 = "<input class=\"_eszkz _l9yih dislike\" name=\""+val[i].code+"\" type=\"image\" id=\"dislike_${obj._id }\" src=\"/images/sheart_full.png\"/>";
					console.log(val[i].content + val.length);
					if (val[i].sender == setid) {
						if(val[i].like =="좋아요") {
							$("#showdm").append(
								"<div id="+val[i].sender+"\" style=\"font-size:16px; text-align: right; \">"
										+ bt2 +"&nbsp;&nbsp;&nbsp;&nbsp;"+ val[i].sender + " : "
										+ val[i].content
										+ "</button>" + "</div>"
										+ "<br/>");			
						}else{
							$("#showdm").append(
								"<div id="+val[i].sender+"\" style=\"font-size:16px; text-align: right; \">"
										+ bt +"&nbsp;&nbsp;&nbsp;&nbsp;"+ val[i].sender + " : "
										+ val[i].content
										+ "</button>" + "</div>"
										+ "<br/>");
						}
					} else {
						if(val[i].like=="좋아요"){
							$("#showdm").append(
								"<div id="+val[i].sender+"\ style=\"text-align: left; \">"
										+ bt2 +"&nbsp;&nbsp;&nbsp;&nbsp;"+ val[i].sender + " : "
										+ val[i].content
										+ "</button>" + "</div>"
										+ "<br/>");						
						} else {
							$("#showdm").append(
								"<div id="+val[i].sender+"\" style=\"text-align: left; \">"
										+ bt +"&nbsp;&nbsp;&nbsp;&nbsp;"+ val[i].sender + " : "
										+ val[i].content
										+ "</button>" + "</div>"
										+ "<br/>");
							console.log("저장하였습니다.")
						}
						target = val[i].sender;
						//console.log(target + "댓그르그");
					}
				}
				
				$("#chatBoard").scrollTop($("#chatBoard").prop("scrollHeight"));
	
				console.log("타켓팅" + target + "scope업데이트");
				$.ajax("/direct/updateScope.do", {
					"method" : "get",
					"async" : true,
					"data" : {
						"sender" : setid,
						"target" : target
	
					}
				}).done(function(val2) {
					var a = 0;
					console.log("업데이트 ");
					$("#sp_" + target).html(" ");
				});
				
				$("#charBoard").scrollTop();
				//======
				//좋아요 취소
				$(".dislike").on("click", function(){
					var oid = $(this).attr("name");
					console.log(oid);
					$.ajax("/direct/deleteLike.do",{
						"method" : "get",
						"async" :true,
						"data" :{
							"sender": setid,
							"target" : reid,
							"oid" : oid			
						}
					}).done(function(val){
						findAllMessage(reid);
					});
				});
				
				//=======
				//좋아요 버튼
				$(".like").on("click", function() {
					var oid = $(this).attr("name");
					console.log(oid);
					$.ajax("/direct/updateLike.do", {
						"method" : "get",
						"async" : true,
						"data" : {
							"sender" : setid,
							"target" : reid,
							"oid" : oid
						}
					}).done(function(val) {
					//=====================================================
						console.log(val+"좋아요 버튼이 들어왔다잉");
						findAllMessage(reid);
					//=====================================================
			}		);
					//====================================================================
				});
			});
		};
</script>
</html>